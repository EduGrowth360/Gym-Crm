<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gym CRM Dashboard</title>
  <link rel="manifest" href="manifest.json">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    /* Custom scrollbars */
    #notificationPanel ul::-webkit-scrollbar,
    .card-container::-webkit-scrollbar,
    .overflow-text-container::-webkit-scrollbar { height: 8px; width: 8px; }
    #notificationPanel ul::-webkit-scrollbar-thumb,
    .card-container::-webkit-scrollbar-thumb,
    .overflow-text-container::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
    .history-list { max-height: 200px; overflow-y: auto; border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem; }
    .history-item { background: #f3f4f6; padding: .5rem; border-radius: .5rem; margin-bottom: .5rem; }
    .overflow-text-container { overflow-x: auto; white-space: nowrap; }
    /* Overdue Trial: full red card with white text */
    .overdue-trial {
      background-color: #ef4444 !important; /* red-500 */
      border: 2px solid #ef4444 !important;
      color: #fff !important;
    }
    .overdue-trial strong,
    .overdue-trial .overflow-text-container,
    .overdue-trial .text-gray-600,
    .overdue-trial .text-blue-600,
    .overdue-trial .text-green-500,
    .overdue-trial .text-red-500,
    .overdue-trial .card-content { color: #fff !important; }
    .overdue-trial .fa-whatsapp { color: #fff !important; }
    .overdue-trial .delete-btn { color: #fff !important; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-5">

  <!-- Auth Screen -->
  <div id="authScreen" class="flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-md max-w-sm w-full">
      <h2 class="text-2xl font-bold text-blue-600 mb-6 text-center">Log In</h2>
      <form id="authForm" class="space-y-4">
        <input id="authUsername" type="text" placeholder="Username" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        <input id="authPassword" type="password" placeholder="Password" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        <button type="submit" class="w-full p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Log In</button>
      </form>
      <p class="text-center text-gray-500 mt-4">Demo creds: <b>admin/admin</b> or <b>reception/reception</b></p>
    </div>
  </div>

  <!-- App -->
  <div id="mainApp" class="hidden">
    <!-- Header -->
    <header class="flex justify-between items-center p-5 bg-white shadow-md rounded-b-lg fixed top-0 left-0 w-full z-10">
      <h1 class="text-2xl font-bold text-blue-600">Gym CRM Dashboard</h1>
      <div class="flex items-center space-x-4">
        <div id="notificationIcon" class="relative cursor-pointer text-xl text-gray-700 hover:text-blue-600">
          🔔<span id="notificationCount" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full scale-0 transition-transform origin-center"></span>
        </div>
        <button id="logoutBtn" class="p-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">Logout</button>
      </div>
      <div id="notificationPanel" class="hidden absolute top-16 right-5 w-80 bg-white rounded-lg shadow-xl z-20">
        <h4 class="p-3 bg-blue-600 text-white font-semibold rounded-t-lg">Notifications</h4>
        <ul id="notificationList" class="list-none m-0 p-3 max-h-80 overflow-y-auto"></ul>
      </div>
    </header>

    <main class="container mx-auto mt-24">
      <!-- Search + Tools -->
      <input id="searchBar" type="text" placeholder="Search client by name..." class="w-full md:max-w-md mx-auto block p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-5">
      <div class="flex flex-wrap items-center gap-2 justify-center md:justify-start mb-4">
        <button id="exportCsvBtn" class="px-3 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">Export CSV</button>
        <label for="importCsvInput" class="px-3 py-2 bg-amber-600 text-white rounded hover:bg-amber-700 cursor-pointer">Import CSV</label>
        <input id="importCsvInput" type="file" accept=".csv" class="hidden">
      </div>

      <!-- Message Box -->
      <div id="messageBox" class="hidden fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
          <p id="messageText" class="text-lg font-semibold mb-4"></p>
          <button id="closeMessageBox" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700">OK</button>
        </div>
      </div>

      <!-- Profile Modal -->
      <div id="profileModal" class="hidden fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full">
          <div class="flex justify-between items-center border-b pb-3 mb-3">
            <h2 class="text-2xl font-bold text-blue-600">Client Profile</h2>
            <button id="closeProfileModal" class="text-gray-500 hover:text-gray-700 text-2xl"><i class="fas fa-times"></i></button>
          </div>
          <div id="profileContent" class="space-y-2"></div>
          <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t">
            <button id="editProfileBtn" class="flex-1 p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Edit</button>
            <button id="moveToNIButton" class="flex-1 p-3 bg-gray-700 text-white font-bold rounded-lg hover:bg-gray-800">Move to Not Interested</button>
            <button id="deleteProfileBtn" class="flex-1 p-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Delete</button>
          </div>
        </div>
      </div>

      <!-- Entry Form -->
      <form id="clientForm" class="bg-white p-6 rounded-lg shadow-md mb-5 max-w-4xl mx-auto">
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="form-group">
            <label class="block text-gray-700 font-medium mb-1">Client Name</label>
            <input id="name" type="text" required class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div class="form-group">
            <label class="block text-gray-700 font-medium mb-1">Phone Number</label>
            <input id="phone" type="text" pattern="^[0-9]{10}$" title="Enter 10 digit number" required class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div class="form-group">
            <label class="block text-gray-700 font-medium mb-1">Email</label>
            <input id="email" type="email" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div class="form-group">
            <label class="block text-gray-700 font-medium mb-1">Status</label>
            <select id="status" onchange="handleStatusChange()" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="Follow-Up">Follow-Up</option>
              <option value="Trial">Trial</option>
              <option value="Active">Active</option>
              <option value="Expiring Soon">Expiring Soon</option>
              <option value="Expired">Expired</option>
              <option value="Not Interested">Not Interested</option>
            </select>
            <!-- Optional manual lock kept for UI continuity (automation ignores it now) -->
            <label class="mt-2 inline-flex items-center gap-2 text-sm text-gray-700">
              <input type="checkbox" id="lockStatus" class="rounded border-gray-300">
              Lock status (manual)
            </label>
          </div>
          <div id="startDateGroup" class="form-group">
            <label class="block text-gray-700 font-medium mb-1">Start Date</label>
            <input id="startDate" type="date" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div id="endDateGroup" class="form-group">
            <label class="block text-gray-700 font-medium mb-1">End Date</label>
            <input id="endDate" type="date" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        <div class="form-group mt-4">
          <label class="block text-gray-700 font-medium mb-1">Note</label>
          <textarea id="note" rows="2" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        </div>
        <div class="flex space-x-2 mt-4">
          <button id="submitButton" type="submit" class="w-full p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Add Client</button>
          <button id="cancelButton" type="button" class="hidden p-3 bg-gray-400 text-white font-bold rounded-lg hover:bg-gray-500">Cancel Edit</button>
        </div>
      </form>

      <!-- Kanban -->
      <div class="board grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-5 p-5 bg-white rounded-lg shadow-md">
        <div class="column bg-gray-50 rounded-lg p-3 shadow-inner" id="Follow-Up" ondragover="allowDrop(event)" ondrop="drop(event)">
          <h3 class="text-lg font-bold text-blue-600 text-center border-b pb-2 mb-2">Follow-Up</h3>
          <div class="card-container overflow-y-auto max-h-96"></div>
        </div>
        <div class="column bg-gray-50 rounded-lg p-3 shadow-inner" id="Trial" ondragover="allowDrop(event)" ondrop="drop(event)">
          <h3 class="text-lg font-bold text-blue-600 text-center border-b pb-2 mb-2">Trial</h3>
          <div class="card-container overflow-y-auto max-h-96"></div>
        </div>
        <div class="column bg-gray-50 rounded-lg p-3 shadow-inner" id="Active" ondragover="allowDrop(event)" ondrop="drop(event)">
          <h3 class="text-lg font-bold text-blue-600 text-center border-b pb-2 mb-2">Active</h3>
          <div class="card-container overflow-y-auto max-h-96"></div>
        </div>
        <div class="column bg-gray-50 rounded-lg p-3 shadow-inner" id="Expiring Soon" ondragover="allowDrop(event)" ondrop="drop(event)">
          <h3 class="text-lg font-bold text-blue-600 text-center border-b pb-2 mb-2">Expiring Soon</h3>
          <div class="card-container overflow-y-auto max-h-96"></div>
        </div>
        <div class="column bg-gray-50 rounded-lg p-3 shadow-inner" id="Expired" ondragover="allowDrop(event)" ondrop="drop(event)">
          <h3 class="text-lg font-bold text-blue-600 text-center border-b pb-2 mb-2">Expired</h3>
          <div class="card-container overflow-y-auto max-h-96"></div>
        </div>
        <div class="column bg-gray-50 rounded-lg p-3 shadow-inner" id="Not Interested" ondragover="allowDrop(event)" ondrop="drop(event)">
          <h3 class="text-lg font-bold text-blue-600 text-center border-b pb-2 mb-2">Not Interested</h3>
          <div class="card-container overflow-y-auto max-h-96"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Elements
    const authScreen = document.getElementById('authScreen');
    const authForm = document.getElementById('authForm');
    const authUsername = document.getElementById('authUsername');
    const authPassword = document.getElementById('authPassword');
    const mainApp = document.getElementById('mainApp');
    const logoutBtn = document.getElementById('logoutBtn');

    const clientForm = document.getElementById('clientForm');
    const submitButton = document.getElementById('submitButton');
    const cancelButton = document.getElementById('cancelButton');
    const board = document.querySelector('.board');
    const searchBar = document.getElementById('searchBar');
    const notificationIcon = document.getElementById('notificationIcon');
    const notificationPanel = document.getElementById('notificationPanel');
    const notificationCount = document.getElementById('notificationCount');
    const notificationList = document.getElementById('notificationList');
    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    const closeMessageBox = document.getElementById('closeMessageBox');
    const profileModal = document.getElementById('profileModal');
    const profileContent = document.getElementById('profileContent');

    let userRole = localStorage.getItem('role') || 'admin';
    let currentEditingCard = null;
    let currentViewingCard = null;
    let allClients = [];

    // Auth
    function checkLoginStatus() {
      const isLoggedIn = localStorage.getItem('isLoggedIn');
      if (isLoggedIn === 'true') {
        authScreen.classList.add('hidden');
        mainApp.classList.remove('hidden');
        loadClientsFromLocalStorage();
      } else {
        authScreen.classList.remove('hidden');
        mainApp.classList.add('hidden');
      }
    }

    authForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const username = authUsername.value.trim();
      const password = authPassword.value.trim();
      if ((username === 'admin' && password === 'admin') || (username === 'reception' && password === 'reception')) {
        const role = (username === 'reception') ? 'receptionist' : 'admin';
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('role', role);
        userRole = role;
        checkLoginStatus();
        showMessageBox(`Logged in as ${role}.`);
      } else {
        showMessageBox('Incorrect username or password.');
      }
    });

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('isLoggedIn');
      localStorage.removeItem('role');
      allClients = [];
      renderAllClients();
      checkLoginStatus();
    });

    // Storage
    function saveClientsToLocalStorage() { localStorage.setItem('gym_clients', JSON.stringify(allClients)); }
    function loadClientsFromLocalStorage() {
      const stored = localStorage.getItem('gym_clients');
      if (stored) { allClients = JSON.parse(stored); renderAllClients(); }
    }

    // UI helpers
    function showMessageBox(text) { messageText.textContent = text; messageBox.classList.remove('hidden'); }
    closeMessageBox.addEventListener('click', () => messageBox.classList.add('hidden'));

    // Status field visibility
    function handleStatusChange() {
      const status = document.getElementById('status').value;
      const start = document.getElementById('startDateGroup');
      const end = document.getElementById('endDateGroup');
      if (status === 'Follow-Up') { start.style.display = 'block'; end.style.display = 'none'; }
      else if (status === 'Not Interested') { start.style.display = 'none'; end.style.display = 'none'; }
      else { start.style.display = 'block'; end.style.display = 'block'; }
    }

    // Parse YYYY-MM-DD as LOCAL date
    function parseLocalDate(str) {
      if (!str) return null;
      const [y, m, d] = str.split('-').map(Number);
      return new Date(y, m - 1, d);
    }

    // Date helpers
    function isExpired(endDate) {
      if (!endDate) return false;
      const today = new Date();
      const end = parseLocalDate(endDate);
      today.setHours(0,0,0,0);
      end.setHours(0,0,0,0);
      return end < today;
    }
    function isExpiringSoon(endDate) {
      if (!endDate) return false;
      const today = new Date();
      const end = parseLocalDate(endDate);
      today.setHours(0,0,0,0);
      end.setHours(0,0,0,0);
      const soon = new Date(today);
      soon.setDate(today.getDate()+2);
      return end <= soon && end >= today;
    }

    // Days since timestamp (status aging)
    function daysSince(ts) {
      if (!ts) return 0;
      const start = new Date(ts);
      const today = new Date();
      start.setHours(0,0,0,0);
      today.setHours(0,0,0,0);
      return Math.floor((today - start) / (1000 * 60 * 60 * 24));
    }

    // Status logic (Trial stays; Follow-Up/Not Interested ignore dates)
    function getCorrectStatus(data) {
      if (data.status === 'Trial') return 'Trial';
      if (data.status === 'Follow-Up' || data.status === 'Not Interested') return data.status;

      if (data.endDate) {
        if (isExpired(data.endDate)) return 'Expired';
        if (isExpiringSoon(data.endDate)) return 'Expiring Soon';
        return 'Active';
      }
      return 'Follow-Up';
    }

    function isPhoneNumberDuplicate(phone, currentId) {
      return allClients.some(c => c.phone === phone && c.id !== currentId);
    }

    // Render
    function renderAllClients() {
      document.querySelectorAll('.card-container').forEach(c => c.innerHTML = '');
      allClients.forEach(data => {
        const card = document.createElement('div');
        card.id = data.id;
        card.className = 'card bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow cursor-pointer mb-2 relative';
        card.setAttribute('data-client', JSON.stringify(data));
        card.setAttribute('draggable', true);

        // Overdue trial visual (but remains in Trial)
        const overdueTrial = (data.status === 'Trial' && isExpired(data.endDate));
        if (overdueTrial) card.classList.add('overdue-trial');

        const showDelete = userRole !== 'receptionist';
        const deleteBtnHtml = showDelete ? '<button class="delete-btn absolute top-2 right-2"><i class="fas fa-trash-alt"></i></button>' : '';
        const waBtnHtml = data.phone ? `<a href="https://wa.me/91${data.phone}" target="_blank" class="absolute top-2 right-10" title="WhatsApp"><i class="fa-brands fa-whatsapp"></i></a>` : '';

        card.innerHTML = `
          <strong class="text-blue-600">${data.name}</strong>
          ${deleteBtnHtml}
          ${waBtnHtml}
          <div class="card-content mt-2">
            ${data.phone ? '<div class="overflow-text-container text-sm text-gray-600">📞 +91-' + data.phone + '</div>' : ''}
            ${data.email ? '<div class="overflow-text-container text-sm text-gray-600">📧 ' + data.email + '</div>' : ''}
            ${data.note ? '<div class="overflow-text-container text-sm text-gray-600">📝 ' + data.note + '</div>' : ''}
            ${data.startDate ? '<div class="overflow-text-container text-xs text-green-500">🟢 Start: ' + data.startDate + '</div>' : ''}
            ${data.endDate ? '<div class="overflow-text-container text-xs text-red-500">🔴 End: ' + data.endDate + '</div>' : ''}
          </div>
        `;
        document.getElementById(data.status).querySelector('.card-container').appendChild(card);
      });
    }

    // Create / Update
    function createCard(data) {
      const initialStatus = data.status;
      data.status = getCorrectStatus(data);
      data.id = `client-${Date.now()}`;
      data.statusSince = Date.now(); // when this status started
      data.history = [{ action: `Client added with status: ${initialStatus}`, timestamp: new Date().toLocaleString() }];
      allClients.push(data);
      saveClientsToLocalStorage();
      renderAllClients();
    }
    function updateCard(card, data) {
      const oldData = allClients.find(c => c.id === card.id) || {};
      const oldStatus = oldData.status;
      const newStatus = getCorrectStatus(data);

      data.status = newStatus;
      data.statusSince = (oldStatus !== newStatus) ? Date.now() : (oldData.statusSince || Date.now());

      const historyEntry = { action: `Client updated from ${oldStatus} to ${newStatus}`, timestamp: new Date().toLocaleString() };
      data.history = oldData.history ? [...oldData.history, historyEntry] : [historyEntry];

      const idx = allClients.findIndex(c => c.id === card.id);
      if (idx > -1) allClients[idx] = { ...data, id: card.id };
      saveClientsToLocalStorage();
      renderAllClients();
    }

    // Notifications
    function addNotification(text) {
      const item = document.createElement('li');
      item.className = 'p-2 border-b border-gray-200 last:border-b-0';
      item.textContent = text;
      notificationList.appendChild(item);
      const current = parseInt(notificationCount.textContent) || 0;
      notificationCount.textContent = current + 1;
      notificationCount.classList.add('scale-100');
    }
    notificationIcon.addEventListener('click', () => {
      notificationPanel.classList.toggle('hidden');
      if (!notificationPanel.classList.contains('hidden')) {
        notificationCount.classList.remove('scale-100');
        notificationCount.textContent = '';
      }
    });

    // Auto engine (Active→Soon/Expired, Expired 7d→Follow-Up)
    function checkAndMoveClients() {
      let changed = false;

      allClients.forEach(client => {
        // 1) Date-based rules
        const computed = getCorrectStatus(client);
        if (computed !== client.status) {
          client.status = computed;
          client.statusSince = Date.now();
          client.history = client.history || [];
          client.history.push({
            action: `Status automatically updated to ${client.status}`,
            timestamp: new Date().toLocaleString()
          });
          addNotification(`${client.name} moved to ${client.status}`);
          changed = true;
        }

        // 2) Aging: Expired for 7+ days -> Follow-Up
        if (client.status === 'Expired' && daysSince(client.statusSince) >= 7) {
          client.status = 'Follow-Up';
          // Optional: clear endDate to avoid confusion
          // client.endDate = '';
          client.statusSince = Date.now();
          client.history.push({
            action: `Aging rule: Expired for 7 days → Follow-Up`,
            timestamp: new Date().toLocaleString()
          });
          addNotification(`${client.name} moved to Follow-Up (aging from Expired).`);
          changed = true;
        }
      });

      if (changed) {
        saveClientsToLocalStorage();
        renderAllClients();
      }
    }
    function scheduleMidnightCheck() {
      const now = new Date(); const next = new Date(now);
      next.setHours(24,0,0,0);
      setTimeout(() => { checkAndMoveClients(); scheduleMidnightCheck(); }, next - now);
    }

    // DnD
    function allowDrop(e) { e.preventDefault(); }
    function drop(e) {
      e.preventDefault();
      const newColumn = e.target.closest('.column');
      if (!newColumn) return;
      const cardId = e.dataTransfer.getData('cardId');
      const card = document.getElementById(cardId);
      if (!card) return;
      const data = allClients.find(c => c.id === cardId);
      const newStatus = newColumn.id;

      // Quick path: drag directly to Not Interested = immediate move
      if (newStatus === 'Not Interested') {
        const dataCopy = { ...data, status: 'Not Interested' };
        updateCard(card, dataCopy);
        addNotification(`${data.name} moved to Not Interested (manual)`);
        return;
      }

      // Otherwise open form prefilled for edit
      document.getElementById('name').value = data.name;
      document.getElementById('phone').value = data.phone;
      document.getElementById('email').value = data.email;
      document.getElementById('status').value = newStatus;
      document.getElementById('startDate').value = data.startDate || '';
      document.getElementById('endDate').value = data.endDate || '';
      document.getElementById('note').value = data.note || '';
      currentEditingCard = card;
      submitButton.textContent = 'Update Client';
      cancelButton.classList.remove('hidden');
      clientForm.scrollIntoView({ behavior: 'smooth' });
      handleStatusChange();
    }
    board.addEventListener('dragstart', (e) => {
      const card = e.target.closest('.card');
      if (card) e.dataTransfer.setData('cardId', card.id);
    });

    // Click handlers (open profile, delete)
    board.addEventListener('click', (e) => {
      const card = e.target.closest('.card');
      if (!card) return;

      // Delete
      if (e.target.closest('.delete-btn')) {
        if (userRole === 'receptionist') { showMessageBox('Receptionists cannot delete clients.'); return; }
        const clientData = allClients.find(c => c.id === card.id);
        const idx = allClients.findIndex(c => c.id === clientData.id);
        if (idx > -1) allClients.splice(idx, 1);
        saveClientsToLocalStorage();
        card.remove();
        addNotification(`${clientData.name} was deleted.`);
        if (currentEditingCard === card) {
          clientForm.reset();
          currentEditingCard = null;
          submitButton.textContent = 'Add Client';
          cancelButton.classList.add('hidden');
        }
        return;
      }

      // Open profile
      currentViewingCard = card;
      const data = allClients.find(c => c.id === card.id);
      let profileHtml = `
        <p><strong>Name:</strong> ${data.name}</p>
        <p><strong>Phone:</strong> ${data.phone ? '+91-' + data.phone : 'N/A'}</p>
        <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
        <p><strong>Status:</strong> ${data.status}</p>
        <p><strong>Start Date:</strong> ${data.startDate || 'N/A'}</p>
        <p><strong>End Date:</strong> ${data.endDate || 'N/A'}</p>
        <p><strong>Note:</strong> ${data.note || 'N/A'}</p>
      `;
      if (data.history && data.history.length) {
        let hist = '<div class="history-list mt-4 border-t pt-4"><h3 class="font-bold text-gray-700">Action History</h3>';
        data.history.forEach(h => { hist += `<div class="history-item text-sm">${h.action}<br><span class="text-gray-500">(${h.timestamp})</span></div>`; });
        hist += '</div>';
        profileHtml += hist;
      }
      profileContent.innerHTML = profileHtml;
      profileModal.classList.remove('hidden');
    });

    document.getElementById('closeProfileModal').addEventListener('click', () => profileModal.classList.add('hidden'));
    document.getElementById('editProfileBtn').addEventListener('click', () => {
      if (!currentViewingCard) return;
      const data = allClients.find(c => c.id === currentViewingCard.id);
      currentEditingCard = currentViewingCard;
      document.getElementById('name').value = data.name;
      document.getElementById('phone').value = data.phone;
      document.getElementById('email').value = data.email;
      document.getElementById('status').value = data.status;
      document.getElementById('startDate').value = data.startDate || '';
      document.getElementById('endDate').value = data.endDate || '';
      document.getElementById('note').value = data.note || '';
      profileModal.classList.add('hidden');
      submitButton.textContent = 'Update Client';
      cancelButton.classList.remove('hidden');
      handleStatusChange();
    });

    document.getElementById('moveToNIButton').addEventListener('click', () => {
      if (!currentViewingCard) return;
      const client = allClients.find(c => c.id === currentViewingCard.id);
      const updated = { ...client, status: 'Not Interested' };
      updateCard(currentViewingCard, updated);
      addNotification(`${client.name} moved to Not Interested (manual)`);
      document.getElementById('profileModal').classList.add('hidden');
    });

    document.getElementById('deleteProfileBtn').addEventListener('click', () => {
      if (!currentViewingCard) return;
      const clientData = allClients.find(c => c.id === currentViewingCard.id);
      const idx = allClients.findIndex(c => c.id === clientData.id);
      if (idx > -1) allClients.splice(idx, 1);
      saveClientsToLocalStorage();
      currentViewingCard.remove();
      addNotification(`${clientData.name} was deleted.`);
      if (currentEditingCard === currentViewingCard) {
        clientForm.reset();
        currentEditingCard = null;
        submitButton.textContent = 'Add Client';
        cancelButton.classList.add('hidden');
      }
      document.getElementById('profileModal').classList.add('hidden');
    });

    // Search
    searchBar.addEventListener('input', function() {
      const q = this.value.toLowerCase();
      document.querySelectorAll('.card').forEach(card => {
        const clientData = allClients.find(c => c.id === card.id);
        if (!clientData) return;
        const hay = `${clientData.name} ${clientData.phone} ${clientData.email} ${clientData.note}`.toLowerCase();
        card.style.display = hay.includes(q) ? 'block' : 'none';
      });
    });

    // Form submit
    clientForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      let phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const status = document.getElementById('status').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const note = document.getElementById('note').value.trim();

      // phone must be 10 digits
      if (!/^[0-9]{10}$/.test(phone)) { showMessageBox('Please enter a valid 10-digit mobile number.'); return; }

      // Follow-Up requires start only; Not Interested requires none; others require both
      if (status !== 'Not Interested' && !startDate) { showMessageBox('A start date is required.'); return; }
      if (status !== 'Follow-Up' && status !== 'Not Interested' && !endDate) { showMessageBox('An end date is required for this status.'); return; }
      if (status !== 'Follow-Up' && status !== 'Not Interested' && startDate && endDate && parseLocalDate(startDate) > parseLocalDate(endDate)) {
        showMessageBox('The end date cannot be before the start date.'); return;
      }

      const currentId = currentEditingCard ? currentEditingCard.id : null;
      if (isPhoneNumberDuplicate(phone, currentId)) { showMessageBox('This phone number already exists.'); return; }

      const data = { name, phone, email, status, startDate, endDate, note };

      if (currentEditingCard) {
        updateCard(currentEditingCard, data);
        addNotification(`${name} updated to ${getCorrectStatus(data)}`);
        currentEditingCard = null;
        submitButton.textContent = 'Add Client';
        cancelButton.classList.add('hidden');
      } else {
        createCard(data);
        addNotification(`${name} added to ${getCorrectStatus(data)}`);
      }

      clientForm.reset();
      handleStatusChange();
    });

    cancelButton.addEventListener('click', () => {
      clientForm.reset();
      currentEditingCard = null;
      submitButton.textContent = 'Add Client';
      cancelButton.classList.add('hidden');
      handleStatusChange();
    });

    // Init
    window.addEventListener('DOMContentLoaded', () => {
      checkLoginStatus();
      handleStatusChange();
      scheduleMidnightCheck();
      checkAndMoveClients();
      // run frequently
      setInterval(checkAndMoveClients, 60 * 1000); // every minute
      window.addEventListener('focus', checkAndMoveClients);
      document.addEventListener('visibilitychange', () => { if (!document.hidden) checkAndMoveClients(); });
    });

    // PWA (optional)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js').catch(() => {});
      });
    }

    // CSV export/import (Save As + fallbacks)
    function toCsvValue(val = '') { return '"' + String(val).replace(/"/g, '""') + '"'; }

    async function exportCsv() {
      const header = ['name','phone','email','status','startDate','endDate','note','statusSince'];
      const rows = allClients.map(c =>
        [c.name,c.phone,c.email,c.status,c.startDate,c.endDate,c.note,c.statusSince || ''].map(toCsvValue).join(',')
      );
      const csv = '\uFEFF' + header.join(',') + '\n' + rows.join('\n'); // BOM for Excel
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });

      if (window.showSaveFilePicker) {
        try {
          const handle = await window.showSaveFilePicker({
            suggestedName: 'gym_clients.csv',
            types: [{ description: 'CSV Files', accept: { 'text/csv': ['.csv'] } }]
          });
          const writable = await handle.createWritable();
          await writable.write(blob);
          await writable.close();
          return;
        } catch (err) { /* user cancelled or not supported — fallback */ }
      }
      try {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'gym_clients.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (_) {
        try {
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank', 'noopener');
          setTimeout(() => URL.revokeObjectURL(url), 10000);
        } catch (_) {}
      }
    }

    function parseCsvLine(line) {
      const re = /,(?=(?:[^"]*"[^"]*")*[^"]*$)/g; // split on commas not inside quotes
      return line.split(re).map(s => s.replace(/^"|"$/g, '').replace(/""/g, '"'));
    }
    function importCsvFile(file) {
      const reader = new FileReader();
      reader.onload = e => {
        const text = e.target.result.trim();
        const lines = text.split(/\r?\n/);
        const header = lines.shift().split(',').map(h => h.trim());
        const idx = key => header.indexOf(key);
        lines.forEach(line => {
          if (!line) return;
          const cols = parseCsvLine(line);
          const data = {
            name: cols[idx('name')] || '',
            phone: cols[idx('phone')] || '',
            email: cols[idx('email')] || '',
            status: cols[idx('status')] || 'Follow-Up',
            startDate: cols[idx('startDate')] || '',
            endDate: cols[idx('endDate')] || '',
            note: cols[idx('note')] || '',
            statusSince: Number(cols[idx('statusSince')]) || Date.now()
          };
          if (!/^[0-9]{10}$/.test(data.phone)) return; // skip bad phones on import
          if (!isPhoneNumberDuplicate(data.phone)) {
            data.id = `client-${Date.now()}-${Math.random().toString(36).slice(2,7)}`;
            const computed = getCorrectStatus(data);
            data.status = computed;
            data.history = [{ action: 'Imported via CSV', timestamp: new Date().toLocaleString() }];
            allClients.push(data);
          }
        });
        saveClientsToLocalStorage();
        renderAllClients();
        addNotification('Import finished');
      };
      reader.readAsText(file);
    }
    document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);
    document.getElementById('importCsvInput').addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (f) importCsvFile(f);
      e.target.value = '';
    });
  </script>
</body>
</html>
